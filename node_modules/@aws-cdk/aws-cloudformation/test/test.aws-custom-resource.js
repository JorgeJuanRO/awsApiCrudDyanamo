"use strict";
const assert_1 = require("@aws-cdk/assert");
const iam = require("@aws-cdk/aws-iam");
const cdk = require("@aws-cdk/cdk");
const lib_1 = require("../lib");
module.exports = {
    'aws sdk js custom resource with onCreate and onDelete'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        new lib_1.AwsCustomResource(stack, 'AwsSdk', {
            onCreate: {
                service: 'CloudWatchLogs',
                action: 'putRetentionPolicy',
                parameters: {
                    logGroupName: '/aws/lambda/loggroup',
                    retentionInDays: 90
                },
                physicalResourceId: 'loggroup'
            },
            onDelete: {
                service: 'CloudWatchLogs',
                action: 'deleteRetentionPolicy',
                parameters: {
                    logGroupName: '/aws/lambda/loggroup',
                }
            }
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('Custom::AWS', {
            "Create": {
                "service": "CloudWatchLogs",
                "action": "putRetentionPolicy",
                "parameters": {
                    "logGroupName": "/aws/lambda/loggroup",
                    "retentionInDays": 90
                },
                "physicalResourceId": "loggroup"
            },
            "Delete": {
                "service": "CloudWatchLogs",
                "action": "deleteRetentionPolicy",
                "parameters": {
                    "logGroupName": "/aws/lambda/loggroup"
                }
            }
        }));
        assert_1.expect(stack).to(assert_1.haveResource('AWS::IAM::Policy', {
            "PolicyDocument": {
                "Statement": [
                    {
                        "Action": "logs:PutRetentionPolicy",
                        "Effect": "Allow",
                        "Resource": "*"
                    },
                    {
                        "Action": "logs:DeleteRetentionPolicy",
                        "Effect": "Allow",
                        "Resource": "*"
                    }
                ],
                "Version": "2012-10-17"
            },
        }));
        test.done();
    },
    'onCreate defaults to onUpdate'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        new lib_1.AwsCustomResource(stack, 'AwsSdk', {
            onUpdate: {
                service: 's3',
                action: 'putObject',
                parameters: {
                    Bucket: 'my-bucket',
                    Key: 'my-key',
                    Body: 'my-body'
                },
                physicalResourceIdPath: 'ETag'
            },
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('Custom::AWS', {
            "Create": {
                "service": "s3",
                "action": "putObject",
                "parameters": {
                    "Bucket": "my-bucket",
                    "Key": "my-key",
                    "Body": "my-body"
                },
                "physicalResourceIdPath": "ETag"
            },
            "Update": {
                "service": "s3",
                "action": "putObject",
                "parameters": {
                    "Bucket": "my-bucket",
                    "Key": "my-key",
                    "Body": "my-body"
                },
                "physicalResourceIdPath": "ETag"
            },
        }));
        test.done();
    },
    'with custom policyStatements'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        new lib_1.AwsCustomResource(stack, 'AwsSdk', {
            onUpdate: {
                service: 'S3',
                action: 'putObject',
                parameters: {
                    Bucket: 'my-bucket',
                    Key: 'my-key',
                    Body: 'my-body'
                },
                physicalResourceIdPath: 'ETag'
            },
            policyStatements: [
                new iam.PolicyStatement({
                    actions: ['s3:PutObject'],
                    resources: ['arn:aws:s3:::my-bucket/my-key']
                })
            ]
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('AWS::IAM::Policy', {
            "PolicyDocument": {
                "Statement": [
                    {
                        "Action": "s3:PutObject",
                        "Effect": "Allow",
                        "Resource": "arn:aws:s3:::my-bucket/my-key"
                    },
                ],
                "Version": "2012-10-17"
            },
        }));
        test.done();
    },
    'fails when no calls are specified'(test) {
        const stack = new cdk.Stack();
        test.throws(() => {
            new lib_1.AwsCustomResource(stack, 'AwsSdk', {});
        }, /`onCreate`.+`onUpdate`.+`onDelete`/);
        test.done();
    },
    'fails when no physical resource method is specified'(test) {
        const stack = new cdk.Stack();
        test.throws(() => {
            new lib_1.AwsCustomResource(stack, 'AwsSdk', {
                onUpdate: {
                    service: 'CloudWatchLogs',
                    action: 'putRetentionPolicy',
                    parameters: {
                        logGroupName: '/aws/lambda/loggroup',
                        retentionInDays: 90
                    }
                }
            });
        }, /`physicalResourceId`.+`physicalResourceIdPath`/);
        test.done();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hd3MtY3VzdG9tLXJlc291cmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5hd3MtY3VzdG9tLXJlc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw0Q0FBdUQ7QUFDdkQsd0NBQXlDO0FBQ3pDLG9DQUFxQztBQUVyQyxnQ0FBMkM7QUFJM0MsaUJBQVM7SUFDUCx1REFBdUQsQ0FBQyxJQUFVO1FBQ2hFLFFBQVE7UUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUU5QixPQUFPO1FBQ1AsSUFBSSx1QkFBaUIsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFO1lBQ3JDLFFBQVEsRUFBRTtnQkFDUixPQUFPLEVBQUUsZ0JBQWdCO2dCQUN6QixNQUFNLEVBQUUsb0JBQW9CO2dCQUM1QixVQUFVLEVBQUU7b0JBQ1YsWUFBWSxFQUFFLHNCQUFzQjtvQkFDcEMsZUFBZSxFQUFFLEVBQUU7aUJBQ3BCO2dCQUNELGtCQUFrQixFQUFFLFVBQVU7YUFDL0I7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsT0FBTyxFQUFFLGdCQUFnQjtnQkFDekIsTUFBTSxFQUFFLHVCQUF1QjtnQkFDL0IsVUFBVSxFQUFFO29CQUNWLFlBQVksRUFBRSxzQkFBc0I7aUJBQ3JDO2FBQ0Y7U0FDRixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsZUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxxQkFBWSxDQUFDLGFBQWEsRUFBRTtZQUMzQyxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLGdCQUFnQjtnQkFDM0IsUUFBUSxFQUFFLG9CQUFvQjtnQkFDOUIsWUFBWSxFQUFFO29CQUNaLGNBQWMsRUFBRSxzQkFBc0I7b0JBQ3RDLGlCQUFpQixFQUFFLEVBQUU7aUJBQ3RCO2dCQUNELG9CQUFvQixFQUFFLFVBQVU7YUFDakM7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLGdCQUFnQjtnQkFDM0Is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QixXQUFXLEVBQUU7b0JBQ1g7d0JBQ0UsUUFBUSxFQUFFLGNBQWM7d0JBQ3hCLFFBQVEsRUFBRSxPQUFPO3dCQUNqQixVQUFVLEVBQUUsK0JBQStCO3FCQUM1QztpQkFDRjtnQkFDRCxTQUFTLEVBQUUsWUFBWTthQUN4QjtTQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELG1DQUFtQyxDQUFDLElBQVU7UUFDNUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7WUFDZixJQUFJLHVCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDN0MsQ0FBQyxFQUFFLG9DQUFvQyxDQUFDLENBQUM7UUFFekMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELHFEQUFxRCxDQUFDLElBQVU7UUFDOUQsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7WUFDZixJQUFJLHVCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUU7Z0JBQ3JDLFFBQVEsRUFBRTtvQkFDUixPQUFPLEVBQUUsZ0JBQWdCO29CQUN6QixNQUFNLEVBQUUsb0JBQW9CO29CQUM1QixVQUFVLEVBQUU7d0JBQ1YsWUFBWSxFQUFFLHNCQUFzQjt3QkFDcEMsZUFBZSxFQUFFLEVBQUU7cUJBQ3BCO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxFQUFFLGdEQUFnRCxDQUFDLENBQUM7UUFFckQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleHBlY3QsIGhhdmVSZXNvdXJjZSB9IGZyb20gJ0Bhd3MtY2RrL2Fzc2VydCc7XG5pbXBvcnQgaWFtID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWlhbScpO1xuaW1wb3J0IGNkayA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2NkaycpO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCB7IEF3c0N1c3RvbVJlc291cmNlIH0gZnJvbSAnLi4vbGliJztcblxuLy8gdHNsaW50OmRpc2FibGU6b2JqZWN0LWxpdGVyYWwta2V5LXF1b3Rlc1xuXG5leHBvcnQgPSB7XG4gICdhd3Mgc2RrIGpzIGN1c3RvbSByZXNvdXJjZSB3aXRoIG9uQ3JlYXRlIGFuZCBvbkRlbGV0ZScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IEF3c0N1c3RvbVJlc291cmNlKHN0YWNrLCAnQXdzU2RrJywge1xuICAgICAgb25DcmVhdGU6IHtcbiAgICAgICAgc2VydmljZTogJ0Nsb3VkV2F0Y2hMb2dzJyxcbiAgICAgICAgYWN0aW9uOiAncHV0UmV0ZW50aW9uUG9saWN5JyxcbiAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgIGxvZ0dyb3VwTmFtZTogJy9hd3MvbGFtYmRhL2xvZ2dyb3VwJyxcbiAgICAgICAgICByZXRlbnRpb25JbkRheXM6IDkwXG4gICAgICAgIH0sXG4gICAgICAgIHBoeXNpY2FsUmVzb3VyY2VJZDogJ2xvZ2dyb3VwJ1xuICAgICAgfSxcbiAgICAgIG9uRGVsZXRlOiB7XG4gICAgICAgIHNlcnZpY2U6ICdDbG91ZFdhdGNoTG9ncycsXG4gICAgICAgIGFjdGlvbjogJ2RlbGV0ZVJldGVudGlvblBvbGljeScsXG4gICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICBsb2dHcm91cE5hbWU6ICcvYXdzL2xhbWJkYS9sb2dncm91cCcsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2spLnRvKGhhdmVSZXNvdXJjZSgnQ3VzdG9tOjpBV1MnLCB7XG4gICAgICBcIkNyZWF0ZVwiOiB7XG4gICAgICAgIFwic2VydmljZVwiOiBcIkNsb3VkV2F0Y2hMb2dzXCIsXG4gICAgICAgIFwiYWN0aW9uXCI6IFwicHV0UmV0ZW50aW9uUG9saWN5XCIsXG4gICAgICAgIFwicGFyYW1ldGVyc1wiOiB7XG4gICAgICAgICAgXCJsb2dHcm91cE5hbWVcIjogXCIvYXdzL2xhbWJkYS9sb2dncm91cFwiLFxuICAgICAgICAgIFwicmV0ZW50aW9uSW5EYXlzXCI6IDkwXG4gICAgICAgIH0sXG4gICAgICAgIFwicGh5c2ljYWxSZXNvdXJjZUlkXCI6IFwibG9nZ3JvdXBcIlxuICAgICAgfSxcbiAgICAgIFwiRGVsZXRlXCI6IHtcbiAgICAgICAgXCJzZXJ2aWNlXCI6IFwiQ2xvdWRXYXRjaExvZ3NcIixcbiAgICAgICAgXCJhY3Rpb25cIjogXCJkZWxldGVSZXRlbnRpb25Qb2xpY3lcIixcbiAgICAgICAgXCJwYXJhbWV0ZXJzXCI6IHtcbiAgICAgICAgICBcImxvZ0dyb3VwTmFtZVwiOiBcIi9hd3MvbGFtYmRhL2xvZ2dyb3VwXCJcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pKTtcblxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgICAgXCJQb2xpY3lEb2N1bWVudFwiOiB7XG4gICAgICAgIFwiU3RhdGVtZW50XCI6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBcIkFjdGlvblwiOiBcImxvZ3M6UHV0UmV0ZW50aW9uUG9saWN5XCIsXG4gICAgICAgICAgICBcIkVmZmVjdFwiOiBcIkFsbG93XCIsXG4gICAgICAgICAgICBcIlJlc291cmNlXCI6IFwiKlwiXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBcIkFjdGlvblwiOiBcImxvZ3M6RGVsZXRlUmV0ZW50aW9uUG9saWN5XCIsXG4gICAgICAgICAgICBcIkVmZmVjdFwiOiBcIkFsbG93XCIsXG4gICAgICAgICAgICBcIlJlc291cmNlXCI6IFwiKlwiXG4gICAgICAgICAgfVxuICAgICAgICBdLFxuICAgICAgICBcIlZlcnNpb25cIjogXCIyMDEyLTEwLTE3XCJcbiAgICAgIH0sXG4gICAgfSkpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ29uQ3JlYXRlIGRlZmF1bHRzIHRvIG9uVXBkYXRlJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBuZXcgQXdzQ3VzdG9tUmVzb3VyY2Uoc3RhY2ssICdBd3NTZGsnLCB7XG4gICAgICBvblVwZGF0ZToge1xuICAgICAgICBzZXJ2aWNlOiAnczMnLFxuICAgICAgICBhY3Rpb246ICdwdXRPYmplY3QnLFxuICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgQnVja2V0OiAnbXktYnVja2V0JyxcbiAgICAgICAgICBLZXk6ICdteS1rZXknLFxuICAgICAgICAgIEJvZHk6ICdteS1ib2R5J1xuICAgICAgICB9LFxuICAgICAgICBwaHlzaWNhbFJlc291cmNlSWRQYXRoOiAnRVRhZydcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0N1c3RvbTo6QVdTJywge1xuICAgICAgXCJDcmVhdGVcIjoge1xuICAgICAgICBcInNlcnZpY2VcIjogXCJzM1wiLFxuICAgICAgICBcImFjdGlvblwiOiBcInB1dE9iamVjdFwiLFxuICAgICAgICBcInBhcmFtZXRlcnNcIjoge1xuICAgICAgICAgIFwiQnVja2V0XCI6IFwibXktYnVja2V0XCIsXG4gICAgICAgICAgXCJLZXlcIjogXCJteS1rZXlcIixcbiAgICAgICAgICBcIkJvZHlcIjogXCJteS1ib2R5XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCJwaHlzaWNhbFJlc291cmNlSWRQYXRoXCI6IFwiRVRhZ1wiXG4gICAgICB9LFxuICAgICAgXCJVcGRhdGVcIjoge1xuICAgICAgICBcInNlcnZpY2VcIjogXCJzM1wiLFxuICAgICAgICBcImFjdGlvblwiOiBcInB1dE9iamVjdFwiLFxuICAgICAgICBcInBhcmFtZXRlcnNcIjoge1xuICAgICAgICAgIFwiQnVja2V0XCI6IFwibXktYnVja2V0XCIsXG4gICAgICAgICAgXCJLZXlcIjogXCJteS1rZXlcIixcbiAgICAgICAgICBcIkJvZHlcIjogXCJteS1ib2R5XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCJwaHlzaWNhbFJlc291cmNlSWRQYXRoXCI6IFwiRVRhZ1wiXG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICd3aXRoIGN1c3RvbSBwb2xpY3lTdGF0ZW1lbnRzJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBuZXcgQXdzQ3VzdG9tUmVzb3VyY2Uoc3RhY2ssICdBd3NTZGsnLCB7XG4gICAgICBvblVwZGF0ZToge1xuICAgICAgICBzZXJ2aWNlOiAnUzMnLFxuICAgICAgICBhY3Rpb246ICdwdXRPYmplY3QnLFxuICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgQnVja2V0OiAnbXktYnVja2V0JyxcbiAgICAgICAgICBLZXk6ICdteS1rZXknLFxuICAgICAgICAgIEJvZHk6ICdteS1ib2R5J1xuICAgICAgICB9LFxuICAgICAgICBwaHlzaWNhbFJlc291cmNlSWRQYXRoOiAnRVRhZydcbiAgICAgIH0sXG4gICAgICBwb2xpY3lTdGF0ZW1lbnRzOiBbXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbJ3MzOlB1dE9iamVjdCddLFxuICAgICAgICAgIHJlc291cmNlczogWydhcm46YXdzOnMzOjo6bXktYnVja2V0L215LWtleSddXG4gICAgICAgIH0pXG4gICAgICBdXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgICBcIlBvbGljeURvY3VtZW50XCI6IHtcbiAgICAgICAgXCJTdGF0ZW1lbnRcIjogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIFwiQWN0aW9uXCI6IFwiczM6UHV0T2JqZWN0XCIsXG4gICAgICAgICAgICBcIkVmZmVjdFwiOiBcIkFsbG93XCIsXG4gICAgICAgICAgICBcIlJlc291cmNlXCI6IFwiYXJuOmF3czpzMzo6Om15LWJ1Y2tldC9teS1rZXlcIlxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICAgIFwiVmVyc2lvblwiOiBcIjIwMTItMTAtMTdcIlxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnZmFpbHMgd2hlbiBubyBjYWxscyBhcmUgc3BlY2lmaWVkJyh0ZXN0OiBUZXN0KSB7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICB0ZXN0LnRocm93cygoKSA9PiB7XG4gICAgICBuZXcgQXdzQ3VzdG9tUmVzb3VyY2Uoc3RhY2ssICdBd3NTZGsnLCB7fSk7XG4gICAgfSwgL2BvbkNyZWF0ZWAuK2BvblVwZGF0ZWAuK2BvbkRlbGV0ZWAvKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICdmYWlscyB3aGVuIG5vIHBoeXNpY2FsIHJlc291cmNlIG1ldGhvZCBpcyBzcGVjaWZpZWQnKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIHRlc3QudGhyb3dzKCgpID0+IHtcbiAgICAgIG5ldyBBd3NDdXN0b21SZXNvdXJjZShzdGFjaywgJ0F3c1NkaycsIHtcbiAgICAgICAgb25VcGRhdGU6IHtcbiAgICAgICAgICBzZXJ2aWNlOiAnQ2xvdWRXYXRjaExvZ3MnLFxuICAgICAgICAgIGFjdGlvbjogJ3B1dFJldGVudGlvblBvbGljeScsXG4gICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgbG9nR3JvdXBOYW1lOiAnL2F3cy9sYW1iZGEvbG9nZ3JvdXAnLFxuICAgICAgICAgICAgcmV0ZW50aW9uSW5EYXlzOiA5MFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSwgL2BwaHlzaWNhbFJlc291cmNlSWRgLitgcGh5c2ljYWxSZXNvdXJjZUlkUGF0aGAvKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9XG59O1xuIl19