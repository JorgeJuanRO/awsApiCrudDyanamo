"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk_1 = require("@aws-cdk/cdk");
const lib_1 = require("../lib");
const util_1 = require("../lib/util");
function exportVpc(vpc) {
    const pub = new ExportSubnetGroup(vpc, 'PublicSubnetIDs', vpc.publicSubnets, lib_1.SubnetType.Public, vpc.availabilityZones.length);
    const priv = new ExportSubnetGroup(vpc, 'PrivateSubnetIDs', vpc.privateSubnets, lib_1.SubnetType.Private, vpc.availabilityZones.length);
    const iso = new ExportSubnetGroup(vpc, 'IsolatedSubnetIDs', vpc.isolatedSubnets, lib_1.SubnetType.Isolated, vpc.availabilityZones.length);
    const vpnGatewayId = vpc.vpnGatewayId
        ? new cdk_1.CfnOutput(vpc, 'VpnGatewayId', { value: vpc.vpnGatewayId }).makeImportValue().toString()
        : undefined;
    return {
        vpcId: new cdk_1.CfnOutput(vpc, 'VpcId', { value: vpc.vpcId }).makeImportValue().toString(),
        vpnGatewayId,
        availabilityZones: vpc.availabilityZones,
        publicSubnetIds: pub.ids,
        publicSubnetNames: pub.names,
        privateSubnetIds: priv.ids,
        privateSubnetNames: priv.names,
        isolatedSubnetIds: iso.ids,
        isolatedSubnetNames: iso.names,
    };
}
exports.exportVpc = exportVpc;
/**
 * Helper class to export/import groups of subnets
 */
class ExportSubnetGroup {
    constructor(scope, exportName, subnets, type, azs) {
        this.subnets = subnets;
        this.type = type;
        this.azs = azs;
        this.groups = subnets.length / azs;
        // ASSERTION
        if (Math.floor(this.groups) !== this.groups) {
            throw new Error(`Number of subnets (${subnets.length}) must be a multiple of number of availability zones (${azs})`);
        }
        this.ids = this.exportIds(scope, exportName);
        this.names = this.exportNames();
    }
    exportIds(scope, name) {
        if (this.subnets.length === 0) {
            return undefined;
        }
        return new cdk_1.StringListCfnOutput(scope, name, { values: this.subnets.map(s => s.subnetId) }).makeImportValues().map(x => x.toString());
    }
    /**
     * Return the list of subnet names if they're not equal to the default
     */
    exportNames() {
        if (this.subnets.length === 0) {
            return undefined;
        }
        const netNames = this.subnets.map(util_1.subnetName);
        // Do some assertion that the 'netNames' array is laid out like this:
        //
        // [ INGRESS, INGRESS, INGRESS, EGRESS, EGRESS, EGRESS, ... ]
        for (let i = 0; i < netNames.length; i++) {
            const k = Math.floor(i / this.azs);
            if (netNames[i] !== netNames[k * this.azs]) {
                throw new Error(`Subnets must be grouped by name, got: ${JSON.stringify(netNames)}`);
            }
        }
        // Splat down to [ INGRESS, EGRESS, ... ]
        const groupNames = util_1.range(this.groups).map(i => netNames[i * this.azs]);
        if (groupNames.length === 1 && groupNames[0] === util_1.defaultSubnetName(this.type)) {
            return undefined;
        }
        return groupNames;
    }
}
exports.ExportSubnetGroup = ExportSubnetGroup;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV4cG9ydC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBeUU7QUFDekUsZ0NBQWtEO0FBQ2xELHNDQUFtRTtBQUVuRSxTQUFnQixTQUFTLENBQUMsR0FBUTtJQUNoQyxNQUFNLEdBQUcsR0FBRyxJQUFJLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxpQkFBaUIsRUFBRSxHQUFHLENBQUMsYUFBYSxFQUFFLGdCQUFVLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5SCxNQUFNLElBQUksR0FBRyxJQUFJLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxrQkFBa0IsRUFBRSxHQUFHLENBQUMsY0FBYyxFQUFFLGdCQUFVLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsSSxNQUFNLEdBQUcsR0FBRyxJQUFJLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxtQkFBbUIsRUFBRSxHQUFHLENBQUMsZUFBZSxFQUFFLGdCQUFVLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUVwSSxNQUFNLFlBQVksR0FBRyxHQUFHLENBQUMsWUFBWTtRQUNuQyxDQUFDLENBQUMsSUFBSSxlQUFTLENBQUMsR0FBRyxFQUFFLGNBQWMsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLEVBQUU7UUFDOUYsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUVkLE9BQU87UUFDTCxLQUFLLEVBQUUsSUFBSSxlQUFTLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLEVB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R0FBRyxDQUFDLENBQUMsQ0FBQztRQUN2RSxJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyx3QkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFBRSxPQUFPLFNBQVMsQ0FBQztTQUFFO1FBRXBHLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7Q0FDRjtBQXBERCw4Q0FvREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZm5PdXRwdXQsIENvbnN0cnVjdCwgU3RyaW5nTGlzdENmbk91dHB1dCB9IGZyb20gJ0Bhd3MtY2RrL2Nkayc7XG5pbXBvcnQgeyBJU3VibmV0LCBTdWJuZXRUeXBlLCBWcGMgfSBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgZGVmYXVsdFN1Ym5ldE5hbWUsIHJhbmdlLCBzdWJuZXROYW1lIH0gZnJvbSAnLi4vbGliL3V0aWwnO1xuXG5leHBvcnQgZnVuY3Rpb24gZXhwb3J0VnBjKHZwYzogVnBjKSB7XG4gIGNvbnN0IHB1YiA9IG5ldyBFeHBvcnRTdWJuZXRHcm91cCh2cGMsICdQdWJsaWNTdWJuZXRJRHMnLCB2cGMucHVibGljU3VibmV0cywgU3VibmV0VHlwZS5QdWJsaWMsIHZwYy5hdmFpbGFiaWxpdHlab25lcy5sZW5ndGgpO1xuICBjb25zdCBwcml2ID0gbmV3IEV4cG9ydFN1Ym5ldEdyb3VwKHZwYywgJ1ByaXZhdGVTdWJuZXRJRHMnLCB2cGMucHJpdmF0ZVN1Ym5ldHMsIFN1Ym5ldFR5cGUuUHJpdmF0ZSwgdnBjLmF2YWlsYWJpbGl0eVpvbmVzLmxlbmd0aCk7XG4gIGNvbnN0IGlzbyA9IG5ldyBFeHBvcnRTdWJuZXRHcm91cCh2cGMsICdJc29sYXRlZFN1Ym5ldElEcycsIHZwYy5pc29sYXRlZFN1Ym5ldHMsIFN1Ym5ldFR5cGUuSXNvbGF0ZWQsIHZwYy5hdmFpbGFiaWxpdHlab25lcy5sZW5ndGgpO1xuXG4gIGNvbnN0IHZwbkdhdGV3YXlJZCA9IHZwYy52cG5HYXRld2F5SWRcbiAgICA/IG5ldyBDZm5PdXRwdXQodnBjLCAnVnBuR2F0ZXdheUlkJywgeyB2YWx1ZTogdnBjLnZwbkdhdGV3YXlJZCB9KS5tYWtlSW1wb3J0VmFsdWUoKS50b1N0cmluZygpXG4gICAgOiB1bmRlZmluZWQ7XG5cbiAgcmV0dXJuIHtcbiAgICB2cGNJZDogbmV3IENmbk91dHB1dCh2cGMsICdWcGNJZCcsIHsgdmFsdWU6IHZwYy52cGNJZCB9KS5tYWtlSW1wb3J0VmFsdWUoKS50b1N0cmluZygpLFxuICAgIHZwbkdhdGV3YXlJZCxcbiAgICBhdmFpbGFiaWxpdHlab25lczogdnBjLmF2YWlsYWJpbGl0eVpvbmVzLFxuICAgIHB1YmxpY1N1Ym5ldElkczogcHViLmlkcyxcbiAgICBwdWJsaWNTdWJuZXROYW1lczogcHViLm5hbWVzLFxuICAgIHByaXZhdGVTdWJuZXRJZHM6IHByaXYuaWRzLFxuICAgIHByaXZhdGVTdWJuZXROYW1lczogcHJpdi5uYW1lcyxcbiAgICBpc29sYXRlZFN1Ym5ldElkczogaXNvLmlkcyxcbiAgICBpc29sYXRlZFN1Ym5ldE5hbWVzOiBpc28ubmFtZXMsXG4gIH07XG59XG5cbi8qKlxuICogSGVscGVyIGNsYXNzIHRvIGV4cG9ydC9pbXBvcnQgZ3JvdXBzIG9mIHN1Ym5ldHNcbiAqL1xuZXhwb3J0IGNsYXNzIEV4cG9ydFN1Ym5ldEdyb3VwIHtcbiAgcHVibGljIHJlYWRvbmx5IGlkcz86IHN0cmluZ1tdO1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZXM/OiBzdHJpbmdbXTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGdyb3VwczogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICAgIGV4cG9ydE5hbWU6IHN0cmluZyxcbiAgICAgIHByaXZhdGUgcmVhZG9ubHkgc3VibmV0czogSVN1Ym5ldFtdLFxuICAgICAgcHJpdmF0ZSByZWFkb25seSB0eXBlOiBTdWJuZXRUeXBlLFxuICAgICAgcHJpdmF0ZSByZWFkb25seSBhenM6IG51bWJlcikge1xuXG4gICAgdGhpcy5ncm91cHMgPSBzdWJuZXRzLmxlbmd0aCAvIGF6cztcblxuICAgIC8vIEFTU0VSVElPTlxuICAgIGlmIChNYXRoLmZsb29yKHRoaXMuZ3JvdXBzKSAhPT0gdGhpcy5ncm91cHMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTnVtYmVyIG9mIHN1Ym5ldHMgKCR7c3VibmV0cy5sZW5ndGh9KSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgbnVtYmVyIG9mIGF2YWlsYWJpbGl0eSB6b25lcyAoJHthenN9KWApO1xuICAgIH1cblxuICAgIHRoaXMuaWRzID0gdGhpcy5leHBvcnRJZHMoc2NvcGUsIGV4cG9ydE5hbWUpO1xuICAgIHRoaXMubmFtZXMgPSB0aGlzLmV4cG9ydE5hbWVzKCk7XG4gIH1cblxuICBwcml2YXRlIGV4cG9ydElkcyhzY29wZTogQ29uc3RydWN0LCBuYW1lOiBzdHJpbmcpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHRoaXMuc3VibmV0cy5sZW5ndGggPT09IDApIHsgcmV0dXJuIHVuZGVmaW5lZDsgfVxuICAgIHJldHVybiBuZXcgU3RyaW5nTGlzdENmbk91dHB1dChzY29wZSwgbmFtZSwgeyB2YWx1ZXM6IHRoaXMuc3VibmV0cy5tYXAocyA9PiBzLnN1Ym5ldElkKSB9KS5tYWtlSW1wb3J0VmFsdWVzKCkubWFwKHggPT4geC50b1N0cmluZygpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdGhlIGxpc3Qgb2Ygc3VibmV0IG5hbWVzIGlmIHRoZXkncmUgbm90IGVxdWFsIHRvIHRoZSBkZWZhdWx0XG4gICAqL1xuICBwcml2YXRlIGV4cG9ydE5hbWVzKCk6IHN0cmluZ1tdIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodGhpcy5zdWJuZXRzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9XG4gICAgY29uc3QgbmV0TmFtZXMgPSB0aGlzLnN1Ym5ldHMubWFwKHN1Ym5ldE5hbWUpO1xuXG4gICAgLy8gRG8gc29tZSBhc3NlcnRpb24gdGhhdCB0aGUgJ25ldE5hbWVzJyBhcnJheSBpcyBsYWlkIG91dCBsaWtlIHRoaXM6XG4gICAgLy9cbiAgICAvLyBbIElOR1JFU1MsIElOR1JFU1MsIElOR1JFU1MsIEVHUkVTUywgRUdSRVNTLCBFR1JFU1MsIC4uLiBdXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXROYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIHRoaXMuYXpzKTtcbiAgICAgIGlmIChuZXROYW1lc1tpXSAhPT0gbmV0TmFtZXNbayAqIHRoaXMuYXpzXSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN1Ym5ldHMgbXVzdCBiZSBncm91cGVkIGJ5IG5hbWUsIGdvdDogJHtKU09OLnN0cmluZ2lmeShuZXROYW1lcyl9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU3BsYXQgZG93biB0byBbIElOR1JFU1MsIEVHUkVTUywgLi4uIF1cbiAgICBjb25zdCBncm91cE5hbWVzID0gcmFuZ2UodGhpcy5ncm91cHMpLm1hcChpID0+IG5ldE5hbWVzW2kgKiB0aGlzLmF6c10pO1xuICAgIGlmIChncm91cE5hbWVzLmxlbmd0aCA9PT0gMSAmJiBncm91cE5hbWVzWzBdID09PSBkZWZhdWx0U3VibmV0TmFtZSh0aGlzLnR5cGUpKSB7IHJldHVybiB1bmRlZmluZWQ7IH1cblxuICAgIHJldHVybiBncm91cE5hbWVzO1xuICB9XG59XG4iXX0=